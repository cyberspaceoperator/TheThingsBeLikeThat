# Deobfuscating Malicious Javascript

There are several ways to start analyzing obfuscated javascript code:

You can beautify it with **js-beautify** to make it more readable

Using **"eval"** works with browser JavaScript scripts and those that run directly on Windows

Browser-specific Javascript can also use statements such as:

* document.write
* document.body.appendChild  (https://www.for610.com/appendchild)
* document.parentNode.insertBefore (https://for610.com/insertbefore)

You can grep for "eval" in javascript code to see if there are any functions to execute deobfuscated code

Example:

<figure><img src="../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

## How to execute and troubleshoot missing definitions, objects, attributes, etc when running a script

You need to supply / define what the javascript is looking for to keep it from erroring out

REMnux has a starter-file that includes many components like objects and methods that a malicious Javascript script might require. This is not all-inclusive

The path for the file is : /usr/share/remnux/objects.js

To use it, supply it as the first argument to SpiderMonkey

**Example:**

```javascript
 js -f /usr/share/remnux/objects.js -f malware.js
```

You can also run it in cscript, on windows, make sure to start AMSI first

```powershell
logman start AMSITrace -p Microsoft-Antimalware-Scan-Interface Event1 -o AMSITrace
.etl -ets

run the malware

cscript <malware.js>

logman stop AMSITrace -ets

AMSIScriptContentRetrieval > malware.js.out

```

Alternatively, you can redefine what "eval" means at the top of \<malware.js>, then run the script with cscript

```javascript
original_eval = eval;
eval = function(input_string) {
	WScript.Echo(input_string);
	original_eval(input_string)
}
```

```
cscript <malware.js>
```

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1).png" alt=""><figcaption><p>Shows that redefining what eval does will output deobfuscated code </p></figcaption></figure>

Sometimes, the objects.js file needs to be edited such as in the case of location.href where a malicious js script might use it's url as a key for decryption. To pass the URL to the script, it's a good idea to change that in the /usr/share/remnux/objects.js file

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1) (1).png" alt=""><figcaption><p>objects.js with malicious url used as decryption key</p></figcaption></figure>





## Tools

| Tool         | Usage                                                                                                                                                                                                                                                            | Description                                                                                                                                                              |
| ------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| js-beautify  | js-beautify \<filename>                                                                                                                                                                                                                                          | Makes javascript more readable, indents, etc                                                                                                                             |
| code         | code \<filename>                                                                                                                                                                                                                                                 | VisualStudio Code program for reading code, has syntax highlighting, etc                                                                                                 |
| Spidermonkey | js -f \<component file> -f \<malware.js>                                                                                                                                                                                                                         | Script interpreter on REMnux, be sure to include components as a file supplied as the first argument There is a component file on remux **/usr/share/remnux/objects.js** |
|              |                                                                                                                                                                                                                                                                  |                                                                                                                                                                          |
| CScript      | <p>logman start AMSITrace -p Microsoft-Antimalware-Scan-Interface Event1 -o AMSITrace .etl -ets<br><br><br>-then-<br><br>cscript &#x3C;malware.js><br><br>-then-<br><br>logman stop AMSITrace -ets<br><br>-then-<br><br>AMSIScriptContentRetrieval > out.txt</p> | Script interpreter on Windows, utilize with AMSI to trace script execution                                                                                               |
| box..js      |                                                                                                                                                                                                                                                                  | Designed to deobfuscate scripts automatically                                                                                                                            |
| base64dump   | base64dump -s \<id number> -d                                                                                                                                                                                                                                    | Dumps base64 from a file and decodes it                                                                                                                                  |
|              |                                                                                                                                                                                                                                                                  |                                                                                                                                                                          |
